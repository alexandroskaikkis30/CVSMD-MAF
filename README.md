# CV-SMD/MAF
This project aims to enhance the sampling of non-equilibrium protein unfolding by performing steered molecular dynamics (SMD) simulations using the constant-velocity method, and by implementing a conditional masked autoregressive flow model for the generation of new samples.

# Overview
This study explores the non-equilibrium mecahnical unfolding of villin headpiece (PDB: 2RJY) by employing steered molecular dynamics simulations using the constant-velocity pulling method, through the TorchMD framework. A pulling protocol similar to that described by Bustamante et al. (2020) in Single-Molecule Studies of Protein Folding with Optical Tweezers was implemented. In this CV-SMD configuration, the pulling mechanism is defined by two reference points that move in opposite directions along the x-axis at constant velocity. Each of the two terminal atoms is harmonically restrained to one of these moving reference points, generating time-dependent forces that drive the unfolding process. This configuration is designed to mimic the physical conditions of Bustamante’s optical tweezers experiment, which is performed in a thermal bath allowing continuous energy exchange between the system and its environment. In TorchMD, temperature control required for the canonical (NVT) ensemble is achieved through its built-in integrator class, and a Langevin integrator was employed to maintain constant temperature throughout the simulation.

Several constant-velocity steered molecular dynamics (CV-SMD) simulations were performed at different pulling velocities. Analysis of the resulting force–extension profiles revealed noise associated with the sampling of similar conformations throughout the trajectories, while fewer samples were observed during unfolding events. These unfolding events correspond primarily to the disruption of secondary structure elements (α-helices) within the villin headpiece. 
<img width="1211" height="598" alt="image" src="https://github.com/user-attachments/assets/fa0a26e2-b5d1-48bc-83fd-2fcb5f349c0a" />

To better capture and generate rare conformational states, different architectures of conditional normalising flow models were employed, specifically variants of the Conditional Masked Autoregressive Flow (MAF) trained on trajectory data conditioned on molecular extension and the restoring forces acting on the terminal atoms. Four models were implemented: a 5-layer MAF conditioned on force (Model A), a 5-layer MAF conditioned on both force and molecular extension (Model B), a 6-layer MAF conditioned on both features (Model C), and a 7-layer MAF conditioned on both features (Model D).

After evaluating the models based on validation and training loss, Model A, which was conditioned on force only, achieved the best validation loss. During generation, it displayed greater stochasticity, producing a wider range of molecular extensions at comparable force values, including higher extensions at lower forces, a pattern that was not present in the training data. In contrast, Model D, which incorporated additional layers and conditioning features, showed the worst validation loss but generated samples in a more controlled mannerand with higher structural accuracy compared to the other models. These results suggest that conditioning on fewer features allows greater generative diversity, while additional conditioning constrains variability, leads to more controlled generation, and may increase the risk of overfitting given the limited size of the available dataset.

# Results 
The molecular extension profile shown below illustrates that Model A can sample conformations reaching higher extensions at lower forces, indicating enhanced exploration of the conformational space. It also highlights the model’s ability to generate novel samples distinct from those observed in the reference dataset.



<img width="670" height="602" alt="image" src="https://github.com/user-attachments/assets/6942fad3-f8ab-45a2-bfd0-a2c351a3ba8f" />



The conformations below illustrate a local structural transition between two MD frames (13.80 ns and 13.90 ns), with the intermediate generated by the 7-layer MAF model with two conditioning features (Model D). The generated structure appears as a physically plausible continuation of the unfolding process, demonstrating controlled sampling through conditioning. However, it also reveals a weakness in precisely capturing secondary structure elements, specifically,  the α-helix region.


   <img width="9062" height="633" alt="image" src="https://github.com/user-attachments/assets/6fdd88b8-0084-43a8-8cb7-e346a7198d4e" />


 
## Repository Structure


```text
CVSMD/MAF
├── outputs/                                   # Generated data, trajectories, and conformations
│   ├── 7_68_conformations/                    # Conformations observed during the CV-SMD simulation, saved as PDB files
│   │                                          # at a pulling velocity of 7.68 Å/ns
│   ├── 7_68.csv                               # Log file monitoring the progress of the same simulation
│   ├── 7_68.npy                               # NumPy array containing trajectory data from the same simulation
│   └── gen_sample.pdb                         # Structure of the sample generated by Model D at 13.81 ns
│
├── scripts/                                   # Python scripts for simulations and model sampling
│   ├── CV-SMD.py                              # Script for running constant-velocity SMD simulations
│   ├── generate.py                            # Script for generating new conformations using trained models
│   ├── model_a.py                             # Model A: 5-layer MAF conditioned on force
│   └── model_d.py                             # Model D: 7-layer MAF conditioned on force and molecular extension
│
├── .gitignore                                 # Files and directories ignored by Git
├── LICENSE                                    # License information
├── README.md                                  # Project overview and documentation
└── requirements.txt                           # Python dependencies for environment setup
```



## Requirements
The project was developed and tested in a **conda environment (Miniconda3)** with **Python 3.7** on a Linux-based HPC cluster.

Main dependencies:
- torch==1.13.1  
- torchmd==1.0.2  
- moleculekit==1.3.4  
- numpy==1.21.5  
- tqdm==4.66.5
- nflows == 0.14
- pandas==1.3.5

All packages can be installed using the provided `requirements.txt` within a conda environment.

## References
Bustamante, C., Alexander, L., Maciuba, K., & Kaiser, C. M. (2020). Single-Molecule Studies of Protein Folding with Optical Tweezers. Annual Review of Biochemistry, 89(1), 443–470. https://doi.org/10.1146/annurev-biochem-013118-111442

Doerr, S., Majewski, M., Pérez, A., Krämer, A., Clementi, C., Noe, F., Giorgino, T., & De Fabritiis, G. (2021). TorchMD: a deep learning framework for molecular simulations. Journal of Chemical Theory and Computation, 17(4), 2355–2363. https://doi.org/10.1021/acs.jctc.0c01343


